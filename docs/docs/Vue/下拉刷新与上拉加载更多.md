# 下拉刷新与上拉加载更多

1. 子组件
```vue
<template>
  <div class="scroller-container" @touchstart="touchStart" @touchmove="touchMove" @touchend="touchEnd" :style="{transform: 'translate3d(0,' + top + 'px, 0)'}">
    <div class="refresh-module">
      <slot name="refresh">
        <div class="refresh-tip refresh-tip-0" v-if="pullDownState === 0">
          <span class="refresh-text">下拉刷新</span>
        </div>
        <div class="refresh-tip refresh-tip-1" v-if="pullDownState === 1">
          <span class="refresh-text">松开刷新</span>
        </div>
        <div class="refresh-tip refresh-tip-2" v-if="pullDownState === 2">
          <span class="refresh-text">刷新中...</span>
        </div>
        <div class="refresh-tip refresh-tip-3" v-if="pullDownState === 3">
          <span class="refresh-text">刷新成功！</span>
        </div>
        <div class="refresh-tip refresh-tip-4" v-if="pullDownState === 4">
          <span class="refresh-text">刷新失败！</span>
        </div>
      </slot>
    </div>
    <slot></slot>
    <div class="load-more-module">
      <slot name="load">
        <div class="load-more-tip load-more-tip-0" v-if="pullUpState === 0">
          <span class="connecting-line"></span>
          <span class="refresh-text">点击或上拉加载更多</span>
          <span class="connecting-line"></span>
        </div>
        <div class="load-more-tip load-more-tip-1" v-if="pullUpState === 1">
          <span class="connecting-line"></span>
          <span class="refresh-text">正在拼命加载中...</span>
          <span class="connecting-line"></span>
        </div>
        <div class="load-more-tip load-more-tip-2" v-if="pullUpState === 2">
          <span class="connecting-line"></span>
          <span class="refresh-text">我是有底线的</span>
          <span class="connecting-line"></span>
        </div>
      </slot>
    </div>
  </div>
</template>

<script>
export default {
    name: 'scroller',

    props: {
        noRefresh: {
            type: Boolean,
            default: () => false
        },

        noLoadMore: {
            type: Boolean,
            default: () => false
        }
    },

    data () {
        return {
            pullDownState: 0, // 0: 下拉刷新, 1: 松开刷新, 2: 刷新中...
            startY: 0,
            top: 0,
            defaultOffset: 50,
            scrollIsToTop: 0,
            pullDown: false,
            isRefreshing: false,
            pullUpState: 0,
            scrollToBottom: false
        };
    },

    created () {
        this.scrollToBottom = true;
        this.pullUpState = 1;
        this.$emit('on-load-more');
    },

    methods: {
        touchStart (e) {
            this.startY = e.targetTouches[0].pageY;
        },

        touchMove (e) {
            this.scrollIsToTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
            if (e.targetTouches[0].pageY > this.startY) { // 下拉
                this.pullDown = true;
                if (this.scrollIsToTop === 0 && !this.isRefreshing) {
                    let diff = e.targetTouches[0].pageY - this.startY - this.scrollIsToTop; // 拉动的距离
                    this.top = Math.pow(diff, 0.8) + (this.pullDownState === 3 ? this.defaultOffset : 0);
                    if (this.top >= this.defaultOffset) {
                        this.pullDownState = 1;
                        e.preventDefault();
                    } else {
                        this.pullDownState = 0;
                        // 去掉会导致ios无法刷新
                        e.preventDefault();
                    }
                }
            } else {
                this.pullDown = false;
                this.pullDownState = 0;

                // 上拉加载更多
                if (this.scrollToBottom || this.pullUpState === 2) return false;
                let scrollHeight = document.querySelector('.scroller-container').clientHeight;
                let scrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
                let offsetHeight = document.documentElement.clientHeight || document.body.scrollHeight;
                if (offsetHeight + scrollTop > scrollHeight - this.defaultOffset - 10) {
                    this.scrollToBottom = true;
                    this.pullUpState = 1;
                    this.$emit('on-load-more');
                }
            }
        },

        touchEnd (e) {
            if (this.pullDown && !this.isRefreshing) {
                if (this.top >= this.defaultOffset) {
                    this.$emit('on-refresh');
                    this.isRefreshing = true;
                    this.pullDownState = 2;
                    this.top = this.defaultOffset;
                } else {
                    this.isRefreshing = false;
                    this.pullDown = false;
                    this.pullDownState = 0;
                    this.top = 0;
                }
            }
        },

        // 刷新成功
        refreshSuccess () {
            this.pullDownState = 3;
            setTimeout(() => {
                this.resetRefreshState();
            }, 500);
        },

        // 刷新失败
        refreshError () {
            this.pullDownState = 4;
            setTimeout(() => {
                this.resetRefreshState();
            }, 500);
        },

        // 重置刷新状态
        resetRefreshState () {
            this.pullDownState = 0;
            this.startY = 0;
            this.top = 0;
            this.pullDown = false;
            this.isRefreshing = false;
        },

        // 重置加载状态
        resetLoadMoreState () {
            this.pullUpState = 0;
            this.scrollToBottom = false;
        },

        // 没有更多
        loadMoreEnd () {
            this.scrollToBottom = true;
            this.pullUpState = 2;
        }
    }
};
</script>

<style lang="scss" scoped>
.scroller-container {
  -webkit-overflow-scrolling: touch; /* ios5+ */
  // 刷新模块
  .refresh-module {
    height: 100px;
    text-align: center;
    margin-top: -100px;
    line-height: 100px;
  }

  // 加载模块
  .load-more-module {
    height: 100px;
    line-height: 100px;
    text-align: center;

    .load-more-tip {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100px;
      width: 100%;
      color: #c0c0c0;
      font-size: 24px;

      .connecting-line {
        display: inline-flex;
        width: 100px;
        height: 2px;
        background: #ddd;
        margin-left: 20px;
        margin-right: 20px;
      }
    }
  }
}
</style>
```

2. 父组件

```vue
<template>
  <div class="scroll-demo">
    <scroller ref="scroller" @on-refresh="refresh" @on-load-more="loadMore">
      <div class="content">
        <h1>{{ refreshNum }}</h1>
        <div v-for="(item, index) in list" :key="index" class="list-item">{{ index + 1 }}</div>
      </div>
    </scroller>
  </div>
</template>

<script>
import scroller from '../../components/scroller';

export default {
    name: 'scrollDemo',

    components: {
        scroller
    },

    data () {
        return {
            refreshNum: 10,
            refreshCount: 0,
            list: [],
            loadCount: 0
        };
    },

    methods: {
        refresh () {
            // 刷新请求
            this.refreshCount++;
            setTimeout(() => {
                // 刷新成功
                if (this.refreshCount % 2 === 1) {
                    this.refreshNum = parseInt(Math.random() * 100);
                    this.$refs['scroller'].refreshSuccess();
                }
                // 刷新失败
                if (this.refreshCount % 2 === 0) {
                    this.$refs['scroller'].refreshError();
                }
            }, 3000);
        },

        // 加载更多
        loadMore () {
            this.loadCount++;
            setTimeout(() => {
                for (let i = 0; i < 11; i++) {
                    this.list.push(i);
                }
                if (this.list.length > 30) {
                    this.$refs['scroller'].loadMoreEnd();
                } else {
                    this.$refs['scroller'].resetLoadMoreState();
                }
            }, 3000);
        }
    }
};
</script>

<style lang='scss' scoped>
.content {
  padding: 0 20px;
  text-align: center;

  h1 {
    margin: 20px auto;
    height: 300px;
    line-height: 300px;
    background: #fafafa;
  }

  .list-item {
    height: 100px;
    line-height: 100px;
    border-bottom: 1px solid #ccc;
  }
}
</style>
```